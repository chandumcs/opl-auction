<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üèè OPL 2025 ‚Äî Admin Auction Console</title>
<style>
  :root{--nav:#002d62;--accent:#ff9800;--blue:#007bff;--bg:#eef3fa}
  body{font-family:Inter,Segoe UI,Arial,sans-serif;background:var(--bg);margin:0}
  header{background:var(--nav);color:#fff;padding:14px 0;text-align:center;font-weight:700}
  .container{max-width:1000px;margin:26px auto;padding:28px;background:#fff;border-radius:12px;box-shadow:0 8px 24px rgba(2,20,56,.08)}
  h3{margin:0 0 8px}
  .muted{color:#475569}
  .price{font-size:40px;color:orange;font-weight:700;margin:8px 0}
  .player-search-wrapper{position:relative;width:360px;margin:18px auto}
  .player-search-wrapper input{width:100%;padding:10px 12px;border-radius:8px;border:1px solid #cfd8e3;font-size:15px}
  .suggestions{position:absolute;left:0;right:0;top:48px;background:#fff;border-radius:8px;border:1px solid #e6eef8;box-shadow:0 6px 18px rgba(2,20,56,.08);z-index:999;display:none;max-height:260px;overflow:auto}
  .suggestions div{padding:10px 12px;cursor:pointer;border-bottom:1px solid #f1f5f9}
  .suggestions div:hover{background:var(--blue);color:#fff}
  .controls{display:flex;gap:12px;justify-content:center;align-items:center;margin-top:12px}
  .btn{padding:10px 14px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
  .btn-blue{background:var(--blue);color:#fff}
  .btn-green{background:#2f9e44;color:#fff}
  .btn-gray{background:#6b7280;color:#fff}
  .owner-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:14px;margin-top:20px}
  .owner{background:var(--accent);color:#fff;border-radius:10px;padding:12px 10px;text-align:center;cursor:pointer}
  table{width:100%;border-collapse:collapse;margin-top:25px}
  th,td{border:1px solid #ddd;padding:8px;text-align:left}
  th{background:#002d62;color:#fff}
  tr:nth-child(even){background:#f9f9f9}
  .filter-section{display:flex;justify-content:space-between;align-items:center;margin-top:30px}
  select{padding:8px 10px;border-radius:6px;border:1px solid #cfd8e3}
  footer{background:var(--nav);color:#fff;text-align:center;padding:12px;margin-top:26px}
</style>
</head>
<body>
<header>üèè OPL 2025 ‚Äî Admin Auction Console</header>

<div class="container">
  <h3 id="playerName">No Player Selected</h3>
  <div id="playerMeta" class="muted">---</div>
  <div class="price" id="currentBid">‚Çπ0</div>
  <div id="topBidder" class="muted">Top Bidder: ---</div>

  <div class="player-search-wrapper">
    <input id="searchPlayer" type="text" placeholder="Search player name...">
    <div id="suggestions" class="suggestions" role="listbox"></div>
  </div>

  <div class="controls">
    <button class="btn btn-blue" id="btn20">+ ‚Çπ20K</button>
    <button class="btn btn-blue" id="btn50">+ ‚Çπ50K</button>
    <input id="customAmount" type="number" placeholder="Custom ‚Çπ" style="padding:10px;border-radius:8px;border:1px solid #cfd8e3;width:120px">
    <button class="btn btn-blue" id="btnAdd">Add</button>
  </div>

  <h3 style="text-align:center;margin-top:18px">Owners</h3>
  <div id="owners" class="owner-grid"></div>

  <div style="text-align:center;margin-top:18px">
    <button class="btn btn-green" id="markSold">‚úÖ Mark Sold</button>
    <button class="btn btn-gray" id="reset">‚ü≥ Reset</button>
  </div>

  <!-- SOLD PLAYERS SECTION -->
  <div class="filter-section">
    <h3>Sold Players List</h3>
    <div>
      <label>Filter by Owner: </label>
      <select id="ownerFilter">
        <option value="All">All Owners</option>
      </select>
      <button class="btn btn-blue" id="exportCSV">‚¨á Export CSV</button>
    </div>
  </div>
  <table id="soldTable">
    <thead>
      <tr>
        <th>Player Name</th>
        <th>Type</th>
        <th>Category</th>
        <th>Location</th>
        <th>Sold Price (‚Çπ)</th>
        <th>Owner</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<footer>¬© 2025 Olive Crypto Systems Pvt. Ltd.</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, get, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDw6bKSkntytlnKFGCW5OTwiv44vE5sIxY",
  authDomain: "opl-2025-season-2.firebaseapp.com",
  databaseURL: "https://opl-2025-season-2-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "opl-2025-season-2",
  storageBucket: "opl-2025-season-2.firebasestorage.app",
  messagingSenderId: "282929654033",
  appId: "1:282929654033:web:535ab2b78937cdfa2b04b0"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const liveRef = ref(db, "/live");

let players = [];
let soldPlayers = {};
let currentPlayer = null;
let currentBid = 0;
let selectedOwner = null;

let owners = {
  Sharath: 64.5,
  "Sarath Chava": 77,
  Teja: 75,
  Vamsi: 69.5,
  Rajan: 62,
  Shabeer: 70,
  Raviraj: 72,
  Mahinder: 66,
};

// DOM Elements
const searchInput = document.getElementById("searchPlayer");
const suggestions = document.getElementById("suggestions");
const playerNameEl = document.getElementById("playerName");
const playerMetaEl = document.getElementById("playerMeta");
const currentBidEl = document.getElementById("currentBid");
const topBidderEl = document.getElementById("topBidder");
const ownersContainer = document.getElementById("owners");
const soldTableBody = document.querySelector("#soldTable tbody");
const ownerFilter = document.getElementById("ownerFilter");

// Load players
get(ref(db, "/players")).then((snapshot) => {
  if (snapshot.exists()) {
    players = Object.values(snapshot.val());
    console.log("Loaded players:", players.length);
  }
});

// Render Owners
function renderOwners() {
  ownersContainer.innerHTML = "";
  Object.entries(owners).forEach(([name, bal]) => {
    const div = document.createElement("div");
    div.className = "owner";
    div.innerHTML = `<b>${name}</b><br>‚Çπ${bal.toFixed(2)} Cr`;
    div.onclick = () => (selectedOwner = name, topBidderEl.textContent = "Top Bidder: " + name);
    ownersContainer.appendChild(div);

    if (![...ownerFilter.options].some(o => o.value === name)) {
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      ownerFilter.appendChild(opt);
    }
  });
}
renderOwners();

// Live update helper
async function updateLive(playerObj) {
  await update(liveRef, playerObj);
}

// Search Suggestion
function showSuggestions(value) {
  const search = value.trim().toLowerCase();
  suggestions.innerHTML = "";
  if (!search) return (suggestions.style.display = "none");

  const matches = players.filter(p => p.name && p.name.toLowerCase().includes(search)).slice(0, 40);
  matches.forEach(p => {
    const div = document.createElement("div");
    div.textContent = `${p.name} (${p.type})`;
    div.onclick = () => {
      searchInput.value = p.name;
      suggestions.style.display = "none";
      selectPlayer(p);
    };
    suggestions.appendChild(div);
  });
  suggestions.style.display = "block";
}
searchInput.addEventListener("input", e => showSuggestions(e.target.value));

// Select Player
function selectPlayer(p) {
  currentPlayer = p;
  currentBid = p.type === "A" ? 20000000 : 5000000;
  playerNameEl.textContent = p.name;
  playerMetaEl.textContent = `Type: ${p.type} | ${p.basePrice} | ${p.location}`;
  currentBidEl.textContent = `‚Çπ${currentBid.toLocaleString()}`;
  topBidderEl.textContent = "Top Bidder: ---";
  selectedOwner = null;

  updateLive({
    name: p.name,
    type: p.type,
    basePrice: p.basePrice,
    location: p.location,
    currentBid: currentBid,
    topBidder: "---"
  });
}

// Bid Buttons
document.getElementById("btn20").onclick = () => increaseBid(20000);
document.getElementById("btn50").onclick = () => increaseBid(50000);
document.getElementById("btnAdd").onclick = () => {
  const val = parseInt(document.getElementById("customAmount").value);
  if (val > 0) increaseBid(val);
};

function increaseBid(amount) {
  if (!currentPlayer) return alert("Select player first!");
  currentBid += amount;
  currentBidEl.textContent = `‚Çπ${currentBid.toLocaleString()}`;
  updateLive({
    currentBid: currentBid,
    topBidder: selectedOwner || "---"
  });
}

// Mark Sold
document.getElementById("markSold").onclick = async () => {
  if (!currentPlayer || !selectedOwner) return alert("Select player & owner first!");
  const ownerBal = owners[selectedOwner];
  const deduction = currentBid / 10000000;
  if (ownerBal < deduction) return alert("Not enough balance!");

  owners[selectedOwner] = ownerBal - deduction;
  renderOwners();

  await set(ref(db, `sold/${currentPlayer.name.replace(/\s+/g, "_")}`), {
    ...currentPlayer,
    soldPrice: currentBid,
    owner: selectedOwner,
    timestamp: new Date().toISOString()
  });

  alert(`${currentPlayer.name} sold to ${selectedOwner} for ‚Çπ${currentBid.toLocaleString()}`);

  // Reset live data
  await updateLive({
    name: "Waiting for next player...",
    type: "---",
    basePrice: "---",
    location: "---",
    currentBid: 0,
    topBidder: "---"
  });

  resetUI();
};

// Reset
document.getElementById("reset").onclick = resetUI;
function resetUI() {
  currentPlayer = null;
  currentBid = 0;
  selectedOwner = null;
  playerNameEl.textContent = "No Player Selected";
  playerMetaEl.textContent = "---";
  currentBidEl.textContent = "‚Çπ0";
  topBidderEl.textContent = "Top Bidder: ---";
  searchInput.value = "";
  suggestions.style.display = "none";
}

// Live update Sold Players
onValue(ref(db, "sold"), (snapshot) => {
  soldPlayers = snapshot.exists() ? snapshot.val() : {};
  renderSoldTable();
});

// Render Sold Table
function renderSoldTable() {
  const filter = ownerFilter.value;
  const list = Object.values(soldPlayers).filter(p => filter === "All" || p.owner === filter);
  soldTableBody.innerHTML = "";
  list.forEach(p => {
    const row = `<tr>
      <td>${p.name}</td>
      <td>${p.type}</td>
      <td>${p.basePrice}</td>
      <td>${p.location}</td>
      <td>‚Çπ${p.soldPrice.toLocaleString()}</td>
      <td>${p.owner}</td>
    </tr>`;
    soldTableBody.insertAdjacentHTML("beforeend", row);
  });
}
ownerFilter.onchange = renderSoldTable;

// Export CSV
document.getElementById("exportCSV").onclick = () => {
  const rows = [["Player Name","Type","Category","Location","Sold Price","Owner"]];
  Object.values(soldPlayers).forEach(p => {
    if (ownerFilter.value === "All" || p.owner === ownerFilter.value)
      rows.push([p.name, p.type, p.basePrice, p.location, p.soldPrice, p.owner]);
  });
  const csv = rows.map(r => r.map(x => `"${x}"`).join(",")).join("\n");
  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "sold_players.csv";
  a.click();
  URL.revokeObjectURL(url);
};
</script>
</body>
</html>

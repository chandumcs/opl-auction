<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>OPL 2025 ‚Äî Admin Auction Console</title>
<style>
  :root{--nav:#002d62;--accent:#ff9800;--blue:#007bff;--bg:#eef3fa}
  body{font-family:Inter,Segoe UI,Arial,sans-serif;background:var(--bg);margin:0}
  header{background:var(--nav);color:#fff;padding:14px 0;text-align:center;font-weight:700}
  .container{max-width:980px;margin:26px auto;padding:28px;background:#fff;border-radius:12px;box-shadow:0 8px 24px rgba(2,20,56,.08)}
  h3{margin:0 0 4px}
  .muted{color:#475569}
  .price{font-size:40px;color:orange;font-weight:700;margin:8px 0}
  .player-search-wrapper{position:relative;width:360px;margin:18px auto}
  .player-search-wrapper input{width:100%;padding:10px 12px;border-radius:8px;border:1px solid #cfd8e3;font-size:15px}
  .suggestions{position:absolute;left:0;right:0;top:48px;background:#fff;border-radius:8px;border:1px solid #e6eef8;box-shadow:0 6px 18px rgba(2,20,56,.08);z-index:999;display:none;max-height:260px;overflow:auto}
  .suggestions div{padding:10px 12px;cursor:pointer;border-bottom:1px solid #f1f5f9}
  .suggestions div:hover{background:var(--blue);color:#fff}
  .controls{display:flex;gap:12px;justify-content:center;align-items:center;margin-top:12px}
  .btn{padding:10px 14px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
  .btn-blue{background:var(--blue);color:#fff}
  .btn-green{background:#2f9e44;color:#fff}
  .btn-gray{background:#6b7280;color:#fff}
  .owner-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:14px;margin-top:20px}
  .owner{background:var(--accent);color:#fff;border-radius:10px;padding:12px 10px;text-align:center;cursor:pointer}
  footer{background:var(--nav);color:#fff;text-align:center;padding:12px;margin-top:26px}
  @media (max-width:600px){.player-search-wrapper{width:92%}}
</style>
</head>
<body>
<header>üèè OPL 2025 ‚Äî Admin Auction Console</header>

<div class="container">
  <h3 id="playerName">No Player Selected</h3>
  <div id="playerMeta" class="muted">---</div>
  <div class="price" id="currentBid">‚Çπ0</div>
  <div id="topBidder" class="muted">Top Bidder: ---</div>

  <div class="player-search-wrapper">
    <input id="searchPlayer" type="text" placeholder="Search player name...">
    <div id="suggestions" class="suggestions" role="listbox"></div>
  </div>

  <div class="controls">
    <button class="btn btn-blue" id="btn20">+ ‚Çπ20K</button>
    <button class="btn btn-blue" id="btn50">+ ‚Çπ50K</button>
    <input id="customAmount" type="number" placeholder="Custom ‚Çπ" style="padding:10px;border-radius:8px;border:1px solid #cfd8e3;width:120px">
    <button class="btn btn-blue" id="btnAdd">Add</button>
  </div>

  <h3 style="text-align:center;margin-top:18px">Owners</h3>
  <div id="owners" class="owner-grid"></div>

  <div style="text-align:center;margin-top:18px">
    <button class="btn btn-green" id="markSold">‚úÖ Mark Sold</button>
    <button class="btn btn-gray" id="reset">‚ü≥ Reset</button>
  </div>
</div>

<footer>¬© 2025 Olive Crypto Systems Pvt. Ltd.</footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getDatabase, ref, get, set, child } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

  // <-- your firebase config (same as you provided)
  const firebaseConfig = {
    apiKey: "AIzaSyDw6bKSkntytlnKFGCW5OTwiv44vE5sIxY",
    authDomain: "opl-2025-season-2.firebaseapp.com",
    databaseURL: "https://opl-2025-season-2-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "opl-2025-season-2",
    storageBucket: "opl-2025-season-2.firebasestorage.app",
    messagingSenderId: "282929654033",
    appId: "1:282929654033:web:535ab2b78937cdfa2b04b0"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // state
  let players = [];          // array of player objects
  let currentPlayer = null;  // selected player object
  let currentBid = 0;
  let selectedOwner = null;

  // Owner balances (in crores) - keep in memory and render
  let owners = {
    Sharath: 64.5,
    "Sarath Chava": 77,
    Teja: 75,
    Vamsi: 69.5,
    Rajan: 62,
    Shabeer: 70,
    Raviraj: 72,
    Mahinder: 66
  };

  // ui refs
  const searchInput = document.getElementById('searchPlayer');
  const suggestions = document.getElementById('suggestions');
  const playerNameEl = document.getElementById('playerName');
  const playerMetaEl = document.getElementById('playerMeta');
  const currentBidEl = document.getElementById('currentBid');
  const topBidderEl = document.getElementById('topBidder');
  const ownersContainer = document.getElementById('owners');

  // load players from /players
  async function loadPlayers(){
    try {
      const snap = await get(ref(db, '/players'));
      if(!snap.exists()){
        console.warn('no players node found in firebase');
        return;
      }
      const data = snap.val();
      players = Object.values(data).filter(p => p && p.name);
      console.log('Loaded players:', players.length);
    } catch(err){
      console.error('Error loading players', err);
    }
  }

  // render owner buttons
  function renderOwners(){
    ownersContainer.innerHTML = '';
    Object.entries(owners).forEach(([name, cr])=>{
      const d = document.createElement('div');
      d.className = 'owner';
      d.innerHTML = `<div style="font-weight:700">${name}</div><div style="font-size:13px;margin-top:6px">‚Çπ${(cr*100).toFixed(2)} L (${cr.toFixed(2)} Cr)</div>`;
      d.onclick = ()=> {
        selectedOwner = name;
        topBidderEl.textContent = `Top Bidder: ${name}`;
      };
      ownersContainer.appendChild(d);
    });
  }

  // choose player (when selected from suggestions)
  function selectPlayer(p){
    currentPlayer = p;
    // base price rule: type A -> 2 Cr, type B -> 0.5 Cr (50 L)
    const base = p.type === 'A' ? 20000000 : 5000000;
    currentBid = base;
    playerNameEl.textContent = p.name;
    playerMetaEl.textContent = `Type: ${p.type} | ${p.basePrice} | ${p.location}`;
    currentBidEl.textContent = `‚Çπ${currentBid.toLocaleString()}`;
    topBidderEl.textContent = 'Top Bidder: ---';
    selectedOwner = null;
  }

  // suggestions: filter players by name substring (case-insensitive)
  function showSuggestions(value){
    const q = (value || '').trim().toLowerCase();
    suggestions.innerHTML = '';
    if(!q){ suggestions.style.display = 'none'; return; }
    // return up to 40 matches to keep it snappy
    const matches = players.filter(p => p.name && p.name.toLowerCase().includes(q)).slice(0,40);
    if(matches.length===0){
      suggestions.innerHTML = `<div>No players found</div>`;
      suggestions.style.display = 'block';
      return;
    }
    matches.forEach(p=>{
      const div = document.createElement('div');
      div.textContent = `${p.name} ‚Äî ${p.type} ‚Äî ${p.basePrice || ''}`;
      div.onclick = ()=>{
        searchInput.value = p.name;
        suggestions.style.display = 'none';
        selectPlayer(p);
      };
      suggestions.appendChild(div);
    });
    suggestions.style.display = 'block';
  }

  // increase bid helpers
  function increaseBid(amount){
    if(!currentPlayer){ alert('Select a player first'); return; }
    currentBid += amount;
    currentBidEl.textContent = `‚Çπ${currentBid.toLocaleString()}`;
  }
  function addCustom(){
    const v = Number(document.getElementById('customAmount').value);
    if(!currentPlayer){ alert('Select player first'); return; }
    if(!v || v<=0){ alert('Enter numeric amount'); return; }
    increaseBid(v);
    document.getElementById('customAmount').value = '';
  }

  // mark sold: deduct owner funds and push sold record
  async function markSold(){
    if(!currentPlayer){ alert('Select player first'); return; }
    if(!selectedOwner){ alert('Select an owner (click an owner card)'); return; }
    // Deduction logic: currentBid is in rupees. Owner balances stored in crores.
    // Convert owner crores -> rupees: owners[selectedOwner]*10000000? No: 1 Cr = 10,000,000 rupees
    const ownerRupees = owners[selectedOwner] * 10000000;
    if(currentBid > ownerRupees){ alert('Not enough balance'); return; }
    // deduct
    const newOwnerCr = (ownerRupees - currentBid) / 10000000;
    owners[selectedOwner] = Number(newOwnerCr.toFixed(2));
    renderOwners();
    // write sold record
    const soldKey = currentPlayer.name.replace(/\s+/g,'_');
    await set(ref(db, `sold/${soldKey}`), {
      ...currentPlayer,
      soldPrice: currentBid,
      owner: selectedOwner,
      timestamp: new Date().toISOString()
    });
    alert(`${currentPlayer.name} sold to ${selectedOwner} for ‚Çπ${currentBid.toLocaleString()}`);
    // reset
    currentPlayer = null;
    currentBid = 0;
    selectedOwner = null;
    playerNameEl.textContent = 'No Player Selected';
    playerMetaEl.textContent = '---';
    currentBidEl.textContent = '‚Çπ0';
    topBidderEl.textContent = 'Top Bidder: ---';
  }

  // reset UI
  function resetUI(){
    currentPlayer = null;
    currentBid = 0;
    selectedOwner = null;
    playerNameEl.textContent = 'No Player Selected';
    playerMetaEl.textContent = '---';
    currentBidEl.textContent = '‚Çπ0';
    topBidderEl.textContent = 'Top Bidder: ---';
    searchInput.value = '';
    suggestions.style.display = 'none';
  }

  // wire UI events AFTER loading players
  (async function init(){
    await loadPlayers();
    renderOwners();
    console.log('Loaded players:', players.length);

    // wire events (attached inside module scope so functions are found)
    searchInput.addEventListener('input', (e)=> showSuggestions(e.target.value));
    document.getElementById('btn20').addEventListener('click', ()=> increaseBid(20000));
    document.getElementById('btn50').addEventListener('click', ()=> increaseBid(50000));
    document.getElementById('btnAdd').addEventListener('click', addCustom);
    document.getElementById('markSold').addEventListener('click', markSold);
    document.getElementById('reset').addEventListener('click', resetUI);

    // click outside suggestions closes it
    document.addEventListener('click', (ev)=>{
      if(!document.querySelector('.player-search-wrapper').contains(ev.target)){
        suggestions.style.display = 'none';
      }
    });
  })();

</script>
</body>
</html>

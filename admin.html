<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>OPL 2025 ‚Äî Admin Control Panel</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --primary: #003D82;
    --secondary: #0056b3;
    --accent: #ff7a00;
    --light-bg: #f4f8ff;
    --white: #ffffff;
  }

  body {
    margin: 0;
    font-family: 'Poppins', sans-serif;
    background: var(--light-bg);
    color: var(--primary);
  }

  header {
    background: var(--primary);
    color: white;
    padding: 12px 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    font-weight: 600;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  }

  header img {
    height: 42px;
    margin-right: 10px;
  }

  .container {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    margin: 30px auto;
    padding: 25px 30px;
    max-width: 850px;
    text-align: center;
  }

  h3 {
    margin-top: 0;
    font-size: 22px;
    color: var(--secondary);
  }

  .bid {
    font-size: 48px;
    color: var(--accent);
    font-weight: 700;
    margin: 10px 0;
  }

  input, select, button {
    font-family: 'Poppins', sans-serif;
    padding: 8px 14px;
    font-size: 15px;
    border-radius: 6px;
    border: 1px solid #ccc;
    margin: 6px;
  }

  button {
    cursor: pointer;
    background: var(--primary);
    color: white;
    border: none;
    transition: 0.3s;
  }

  button:hover {
    background: var(--secondary);
  }

  #customAmount {
    width: 130px;
    text-align: center;
  }

  .ownerGrid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 12px;
    margin: 25px 0;
  }

  .ownerCard {
    background: var(--primary);
    color: white;
    padding: 10px 12px;
    border-radius: 10px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    transition: 0.3s;
    cursor: pointer;
  }

  .ownerCard:hover {
    background: var(--secondary);
    transform: scale(1.02);
  }

  .ownerCard .wallet {
    font-size: 13px;
    color: #c9e7ff;
    margin-top: 3px;
  }

  .soldList {
    background: white;
    border-radius: 12px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    padding: 20px;
    max-width: 850px;
    margin: 20px auto;
    text-align: left;
  }

  .soldList h4 {
    color: var(--secondary);
    border-bottom: 2px solid var(--accent);
    padding-bottom: 8px;
  }

  .sold {
    border-bottom: 1px solid #e8e8e8;
    padding: 6px 0;
    font-size: 15px;
  }

  footer {
    text-align: center;
    background: var(--primary);
    color: white;
    padding: 10px;
    font-size: 13px;
  }

  .export {
    text-align: center;
    margin-top: 25px;
  }

  .export button {
    background: var(--accent);
    border: none;
  }

  .export button:hover {
    background: #e86a00;
  }
</style>
</head>
<body>

<header>
  <img src="assets/logo.png" alt="Olive Logo">
  OPL 2025 ‚Äî Admin Control Panel
</header>

<div class="container">
  <h3>üéØ Select Player to Start Auction</h3>
  <p><strong id="playerName">---</strong></p>
  <p>Type: <span id="playerType">---</span> | Base Price: ‚Çπ<span id="basePrice">0</span></p>

  <div class="bid" id="currentBid">‚Çπ0</div>
  <p>Top Bidder: <span id="currentBidder">---</span></p>

  <input list="playerList" id="searchBox" type="text" placeholder="Search Player..." />
  <datalist id="playerList"></datalist>
  <button onclick="searchPlayer()">Search</button>

  <div class="ownerGrid" id="ownerGrid"></div>

  <div>
    <button onclick="increaseBid(2000000)">+ ‚Çπ20 L</button>
    <button onclick="increaseBid(5000000)">+ ‚Çπ50 L</button>
    <input type="number" id="customAmount" placeholder="Custom ‚Çπ" min="1" onkeypress="return event.charCode>=48 && event.charCode<=57">
    <button onclick="addCustomBid()">Add</button>
    <button style="background:green" onclick="markSold()">Mark Sold</button>
  </div>
</div>

<div class="soldList">
  <h4>üèè Sold Players / Auction History</h4>
  <div id="soldList"></div>
</div>

<div class="export">
  <label for="exportOwner"><b>Export Sold Players:</b></label>
  <select id="exportOwner">
    <option value="All">All Owners</option>
    <option>Sharath</option><option>Sarath Chava</option><option>Teja</option>
    <option>Vamsi</option><option>Rajan</option><option>Shabeer</option>
    <option>Ravi Raj</option><option>Mahinder</option>
  </select>
  <button onclick="exportSoldPlayers()">üì§ Export Filtered</button>
  <button onclick="exportAllOwners()">üìò Export All Owners</button>
</div>

<footer>
  ¬© 2025 Olive Crypto Systems Pvt Ltd ‚Äî OPL 2025 Admin Control
</footer>

<!-- Firebase & XLSX -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDw6bKSkntytlnKFGCW5OTwiv44vE5sIxY",
    authDomain: "opl-2025-season-2.firebaseapp.com",
    databaseURL: "https://opl-2025-season-2-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "opl-2025-season-2",
    storageBucket: "opl-2025-season-2.firebasestorage.app",
    messagingSenderId: "282929654033",
    appId: "1:282929654033:web:535ab2b78937cdfa2b04b0"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const Cr = 10000000;

  const ownersList = ["Sharath","Sarath Chava","Teja","Vamsi","Rajan","Shabeer","Ravi Raj","Mahinder"];
  const initialOwners = {
    "Sharath":{captain:"Kalyan",walletCr:64.5},"Sarath Chava":{captain:"Sai",walletCr:77},
    "Teja":{captain:"Shashank",walletCr:75},"Vamsi":{captain:"Surender",walletCr:69.5},
    "Rajan":{captain:"Vamsi",walletCr:62},"Shabeer":{captain:"Vijayander",walletCr:70},
    "Ravi Raj":{captain:"Suresh",walletCr:72},"Mahinder":{captain:"Sai Varma",walletCr:66}
  };

  function initOwners(){
    Object.entries(initialOwners).forEach(([n,o])=>{
      db.ref('owners/'+n).once('value').then(s=>{
        if(!s.exists()) db.ref('owners/'+n).set({captain:o.captain,wallet:o.walletCr*Cr});
      });
    });
  }

  let players={},selectedKey=null,currentBid=0,currentBidder=null;
  db.ref('players').on('value',s=>{players=s.val()||{};});
  db.ref('players').once('value',snap=>{
    const list=document.getElementById('playerList');
    if(!snap.exists())return;
    Object.values(snap.val()).forEach(p=>{
      const opt=document.createElement('option');opt.value=p.name;list.appendChild(opt);
    });
  });

  function loadOwnersGrid(){
    const g=document.getElementById('ownerGrid');g.innerHTML='';
    Object.keys(initialOwners).forEach(n=>{
      const d=document.createElement('div');d.className='ownerCard';
      d.innerHTML=`<div>${n}</div><div>${initialOwners[n].captain}</div><div class="wallet" id="wallet_${n}">Loading...</div>`;
      d.onclick=()=>selectBidder(n);g.appendChild(d);
    });
    db.ref('owners').on('value',s=>{
      const o=s.val()||{};
      Object.keys(o).forEach(k=>{
        const el=document.getElementById('wallet_'+k);
        if(el) el.innerText='‚Çπ'+Number(o[k].wallet||0).toLocaleString()+' ('+((Number(o[k].wallet||0)/Cr).toFixed(2))+' Cr)';
      });
    });
  }

  function searchPlayer(){
    const q=document.getElementById('searchBox').value.toLowerCase();
    const k=Object.keys(players).find(k=>(players[k].name||'').toLowerCase().includes(q));
    if(!k)return alert('Player not found');
    selectedKey=k;const p=players[k];
    document.getElementById('playerName').innerText=p.name||'---';
    document.getElementById('playerType').innerText=p.type||'-';
    document.getElementById('basePrice').innerText=p.basePrice||0;
    currentBid=Number(p.currentBid||0);updateBid();
    db.ref('live').set({currentPlayerKey:k,currentBid,currentBidder:currentBidder||null});
  }

  function selectBidder(n){currentBidder=n;document.getElementById('currentBidder').innerText=n;}

  async function increaseBid(a){
    if(!selectedKey)return alert('Select player first');
    if(!currentBidder)return alert('Select owner first');
    const s=await db.ref('owners/'+currentBidder+'/wallet').once('value');
    const w=Number(s.val()||0),prop=currentBid+a;
    if(w<prop)return alert('Not enough balance');
    currentBid=prop;updateBid();
    db.ref('live').set({currentPlayerKey:selectedKey,currentBid,currentBidder});
  }

  function addCustomBid(){
    const c=Number(document.getElementById('customAmount').value);
    if(!c||c<=0)return alert('Enter valid amount');increaseBid(c);
    document.getElementById('customAmount').value='';
  }

  function markSold(){
    if(!selectedKey||!currentBidder)return alert('Select player & owner');
    const r=db.ref('owners/'+currentBidder+'/wallet');
    r.transaction(w=>w-currentBid,async(e,c)=>{
      if(!c)return alert('Not enough balance');
      const p=players[selectedKey];
      const d={...p,team:currentBidder,currentBid,status:'sold'};
      await db.ref('players/'+selectedKey).update(d);
      await db.ref('soldPlayers').push(d);
      alert(`${p.name} sold to ${currentBidder} for ‚Çπ${currentBid.toLocaleString()}`);
      db.ref('live').set({});currentBid=0;updateBid();
      document.getElementById('currentBidder').innerText='---';
    });
  }

  function updateBid(){document.getElementById('currentBid').innerText='‚Çπ'+currentBid.toLocaleString();}

  db.ref('soldPlayers').on('value',s=>{
    const e=document.getElementById('soldList');e.innerHTML='';
    if(!s.exists())return;
    Object.values(s.val()).reverse().forEach(p=>{
      const d=document.createElement('div');d.className='sold';
      d.innerHTML=`<b>${p.name}</b> (${p.category||''}) ‚Äî ‚Çπ${p.currentBid.toLocaleString()} | ${p.team}`;
      e.appendChild(d);
    });
  });

  async function exportSoldPlayers(){
    const f=document.getElementById('exportOwner').value;
    const s=await db.ref('soldPlayers').once('value');
    if(!s.exists())return alert('No sold players found!');
    const data=Object.values(s.val());
    const fil=f==="All"?data:data.filter(p=>p.team===f);
    if(fil.length===0)return alert('No records for this owner!');
    const exp=fil.map(p=>({
      "Player Name":p.name||"","Type":p.type||"","Category":p.category||"",
      "Base Price":p.basePrice||"","Sold Price":p.currentBid||0,
      "Team Owner":p.team||"","Status":p.status||""
    }));
    const ws=XLSX.utils.json_to_sheet(exp);
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,"Sold Players");
    XLSX.writeFile(wb,f==="All"?"All_Sold_Players.xlsx":f+"_Sold_Players.xlsx");
  }

async function exportAllOwners() {
  const s = await db.ref('soldPlayers').once('value');
  if (!s.exists()) return alert('No sold players!');
  const all = Object.values(s.val());
  const wb = XLSX.utils.book_new();

  ownersList.forEach(o => {
    const pl = all.filter(p => p.team === o);
    if (pl.length > 0) {
      // Prepare player data
      const sheetData = pl.map(p => ({
        "Player Name": p.name || "",
        "Type": p.type || "",
        "Category": p.category || "",
        "Base Price": p.basePrice || "",
        "Sold Price": p.currentBid || 0,
        "Team Owner": p.team || "",
        "Status": p.status || ""
      }));

      // Create worksheet with a single header row (no duplication)
      const ws = XLSX.utils.json_to_sheet(sheetData, { skipHeader: false });

      // Calculate total & player count
      const totalSpent = pl.reduce((s, p) => s + (p.currentBid || 0), 0);
      const totalPlayers = pl.length;

      // Add a blank line + total summary
      XLSX.utils.sheet_add_aoa(ws, [[""]], { origin: -1 });
      XLSX.utils.sheet_add_aoa(ws, [
        [`TOTAL SPENT ‚Üí ‚Çπ${totalSpent.toLocaleString()}`, "", "", "", "", "", `Total Players: ${totalPlayers}`]
      ], { origin: -1 });

      // Set column widths
      ws["!cols"] = [
        { wch: 22 }, { wch: 8 }, { wch: 14 }, { wch: 12 },
        { wch: 14 }, { wch: 16 }, { wch: 10 }
      ];

      // Style headers (bold blue row)
      const headerRange = XLSX.utils.decode_range(ws["!ref"]);
      for (let C = headerRange.s.c; C <= headerRange.e.c; ++C) {
        const headerCell = XLSX.utils.encode_cell({ r: 0, c: C });
        if (ws[headerCell]) {
          ws[headerCell].s = {
            font: { bold: true, color: { rgb: "FFFFFF" } },
            fill: { fgColor: { rgb: "003D82" } },
            alignment: { horizontal: "center", vertical: "center" }
          };
        }
      }

      // Style total row (bold green)
      const totalRowIndex = sheetData.length + 2;
      const totalCell = XLSX.utils.encode_cell({ r: totalRowIndex, c: 0 });
      if (ws[totalCell]) {
        ws[totalCell].s = {
          font: { bold: true, color: { rgb: "FFFFFF" } },
          fill: { fgColor: { rgb: "1B5E20" } },
          alignment: { horizontal: "left" }
        };
      }

      XLSX.utils.book_append_sheet(wb, ws, o);
    }
  });

  XLSX.writeFile(wb, "OPL_SoldPlayers_AllOwners.xlsx");
  alert("‚úÖ Excel exported successfully ‚Äî single clean header per owner!");
}



  initOwners();loadOwnersGrid();
</script>
</body>
</html>




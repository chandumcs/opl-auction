<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OPL 2025 ‚Äî Admin Control Panel</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f4ff;
      color: #002b5c;
      text-align: center;
      margin: 0;
    }
    header {
      background: #002b5c;
      color: white;
      padding: 15px;
      font-size: 22px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    header img { height: 40px; margin-right: 10px; }
    .container {
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      margin: 30px auto;
      width: 90%;
      max-width: 800px;
      padding: 20px;
    }
    .bid {
      font-size: 40px;
      font-weight: bold;
      color: orange;
      margin: 10px 0;
    }
    input, button, select {
      padding: 8px 14px;
      font-size: 15px;
      border-radius: 5px;
      border: 1px solid #ccc;
      margin: 5px;
    }
    button {
      cursor: pointer;
      background: #007bff;
      color: white;
      border: none;
    }
    button:hover { background: #0056b3; }
    .ownerGrid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin: 20px auto;
      max-width: 700px;
    }
    .ownerCard {
      background: #003d82;
      color: white;
      border-radius: 8px;
      padding: 10px;
      cursor: pointer;
      transition: 0.2s;
    }
    .ownerCard:hover { background: #0056b3; }
    .ownerCard .wallet { font-size: 13px; color: #b6e1ff; }
    .soldList {
      background: #f9fafc;
      border-radius: 10px;
      padding: 15px;
      margin: 20px auto;
      width: 90%;
      max-width: 800px;
      text-align: left;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }
    .sold { border-bottom: 1px solid #ddd; padding: 6px 0; }
    #customAmount { width: 100px; text-align: center; }
  </style>
</head>
<body>
  <header>
    <img src="assets/logo.png" alt="Olive Logo"> OPL 2025 ‚Äî Admin Control Panel
  </header>

  <div class="container">
    <h3>Select Player to Start Auction</h3>
    <p id="playerName">---</p>
    <p>Type: <span id="playerType">---</span> | Base Price: ‚Çπ<span id="basePrice">0</span></p>
    <div class="bid" id="currentBid">‚Çπ0</div>
    <p>Top Bidder: <span id="currentBidder">---</span></p>

    <input list="playerList" id="searchBox" type="text" placeholder="Search Player..." />
    <datalist id="playerList"></datalist>
    <button onclick="searchPlayer()">Search Player</button>

    <div class="ownerGrid" id="ownerGrid"></div>

    <!-- Bid Section -->
    <div>
      <button onclick="increaseBid(20000)">+ ‚Çπ20K</button>
      <button onclick="increaseBid(50000)">+ ‚Çπ50K</button>
      <input type="number" id="customAmount" placeholder="Custom ‚Çπ" min="1" onkeypress="return event.charCode>=48 && event.charCode<=57">
      <button onclick="addCustomBid()">Add Custom Bid</button>
      <button style="background:green" onclick="markSold()">Mark Sold</button>
    </div>
  </div>

  <div class="soldList">
    <h4>üèè Sold Players / Auction History</h4>
    <div id="soldList"></div>
  </div>

  <!-- Export Section -->
  <div style="margin-top:20px;">
    <label for="exportOwner">Filter by Owner: </label>
    <select id="exportOwner">
      <option value="All">All Owners</option>
      <option value="Sharath">Sharath</option>
      <option value="Sarath Chava">Sarath Chava</option>
      <option value="Teja">Teja</option>
      <option value="Vamsi">Vamsi</option>
      <option value="Rajan">Rajan</option>
      <option value="Shabeer">Shabeer</option>
      <option value="Ravi Raj">Ravi Raj</option>
      <option value="Mahinder">Mahinder</option>
    </select>
    <button onclick="exportSoldPlayers()">üì§ Export Sold Players</button>
  </div>

  <footer style="background:#002b5c;color:white;padding:10px;font-size:14px;">
    ¬© 2025 Olive Crypto Systems Pvt. Ltd. ‚Äî OPL 2025 Admin Control
  </footer>

  <!-- Firebase and Excel -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDw6bKSkntytlnKFGCW5OTwiv44vE5sIxY",
      authDomain: "opl-2025-season-2.firebaseapp.com",
      databaseURL: "https://opl-2025-season-2-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "opl-2025-season-2",
      storageBucket: "opl-2025-season-2.firebasestorage.app",
      messagingSenderId: "282929654033",
      appId: "1:282929654033:web:535ab2b78937cdfa2b04b0"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const Cr = 10000000;
    const initialOwners = {
      "Sharath": { captain: "Kalyan", walletCr: 64.5 },
      "Sarath Chava": { captain: "Sai", walletCr: 77 },
      "Teja": { captain: "Shashank", walletCr: 75 },
      "Vamsi": { captain: "Surender", walletCr: 69.5 },
      "Rajan": { captain: "Vamsi", walletCr: 62 },
      "Shabeer": { captain: "Vijayander", walletCr: 70 },
      "Ravi Raj": { captain: "Suresh", walletCr: 72 },
      "Mahinder": { captain: "Sai Varma", walletCr: 66 }
    };

    function initOwners() {
      Object.entries(initialOwners).forEach(([name, o]) => {
        db.ref('owners/' + name).once('value').then(s => {
          if (!s.exists()) db.ref('owners/' + name).set({ captain: o.captain, wallet: o.walletCr * Cr });
        });
      });
    }

    let players = {};
    let selectedKey = null;
    let currentBid = 0;
    let currentBidder = null;

    db.ref('players').on('value', s => { players = s.val() || {}; });
    db.ref('players').once('value', snap => {
      const list = document.getElementById('playerList');
      if (!snap.exists()) return;
      Object.values(snap.val()).forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.name;
        list.appendChild(opt);
      });
    });

    function loadOwnersGrid() {
      const grid = document.getElementById('ownerGrid');
      grid.innerHTML = '';
      Object.keys(initialOwners).forEach(name => {
        const d = document.createElement('div');
        d.className = 'ownerCard';
        d.innerHTML = `<div>${name}</div><div>${initialOwners[name].captain}</div><div class="wallet" id="wallet_${name}">Loading...</div>`;
        d.onclick = () => selectBidder(name);
        grid.appendChild(d);
      });
      db.ref('owners').on('value', s => {
        const obj = s.val() || {};
        Object.keys(obj).forEach(k => {
          const el = document.getElementById('wallet_' + k);
          if (el) el.innerText = '‚Çπ' + Number(obj[k].wallet || 0).toLocaleString() + ' (' + ((Number(obj[k].wallet||0)/Cr).toFixed(2)) + 'Cr)';
        });
      });
    }

    function searchPlayer() {
      const q = document.getElementById('searchBox').value.toLowerCase();
      const key = Object.keys(players).find(k => (players[k].name || '').toLowerCase().includes(q));
      if (!key) return alert('Player not found');
      selectedKey = key;
      const p = players[key];
      document.getElementById('playerName').innerText = p.name || "---";
      document.getElementById('playerType').innerText = p.type || "-";
      document.getElementById('basePrice').innerText = p.basePrice || 0;
      currentBid = Number(p.currentBid || 0);
      updateBid();
      db.ref('live').set({ currentPlayerKey: key, currentBid: currentBid, currentBidder: currentBidder || null });
    }

    function selectBidder(name) {
      currentBidder = name;
      document.getElementById('currentBidder').innerText = name;
    }

    async function increaseBid(amount) {
      if (!selectedKey) return alert('Select a player first');
      if (!currentBidder) return alert('Select an owner first');
      const snap = await db.ref('owners/' + currentBidder + '/wallet').once('value');
      const wallet = Number(snap.val() || 0);
      const proposed = currentBid + amount;
      if (wallet < proposed) return alert('Not enough balance');
      currentBid = proposed;
      updateBid();
      db.ref('live').set({ currentPlayerKey:selectedKey, currentBid, currentBidder });
    }

    function addCustomBid() {
      const custom = Number(document.getElementById('customAmount').value);
      if (!custom || custom <= 0) return alert("Enter a valid amount!");
      increaseBid(custom);
      document.getElementById('customAmount').value = '';
    }

    function markSold() {
      if (!selectedKey || !currentBidder) return alert('Select player and owner');
      const ref = db.ref('owners/' + currentBidder + '/wallet');
      ref.transaction(wallet => wallet - currentBid, async (err, committed) => {
        if (!committed) return alert('Not enough balance');
        const p = players[selectedKey];
        const data = { ...p, team: currentBidder, currentBid, status:'sold' };
        await db.ref('players/' + selectedKey).update(data);
        await db.ref('soldPlayers').push(data);
        alert(`${p.name} sold to ${currentBidder} for ‚Çπ${currentBid.toLocaleString()}`);
        db.ref('live').set({});
        currentBid = 0;
        updateBid();
        document.getElementById('currentBidder').innerText = '---';
      });
    }

    function updateBid() {
      document.getElementById('currentBid').innerText = '‚Çπ' + currentBid.toLocaleString();
    }

    db.ref('soldPlayers').on('value', s => {
      const el = document.getElementById('soldList');
      el.innerHTML = '';
      if (!s.exists()) return;
      Object.values(s.val()).reverse().forEach(p => {
        const d = document.createElement('div');
        d.className = 'sold';
        d.innerHTML = `<strong>${p.name}</strong> ‚Äî ‚Çπ${p.currentBid.toLocaleString()} | ${p.team}`;
        el.appendChild(d);
      });
    });

    async function exportSoldPlayers() {
      const ownerFilter = document.getElementById('exportOwner').value;
      const snap = await db.ref('soldPlayers').once('value');
      if (!snap.exists()) return alert('No sold players found!');
      const data = Object.values(snap.val());
      const filtered = ownerFilter === "All" ? data : data.filter(p => p.team === ownerFilter);
      if (filtered.length === 0) return alert('No records found for this owner!');
      const exportData = filtered.map(p => ({
        PlayerName: p.name || "",
        Type: p.type || "",
        Category: p.category || "",
        BasePrice: p.basePrice || "",
        SoldPrice: p.currentBid || 0,
        TeamOwner: p.team || "",
        Status: p.status || "",
      }));
      const ws = XLSX.utils.json_to_sheet(exportData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Sold Players");
      const fileName = ownerFilter === "All" ? "All_Sold_Players.xlsx" : ownerFilter + "_Sold_Players.xlsx";
      XLSX.writeFile(wb, fileName);
    }

    initOwners();
    loadOwnersGrid();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OPL 2025 ‚Äî Admin Control Panel</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f4ff;
      color: #002b5c;
      text-align: center;
      margin: 0;
    }
    header {
      background: #002b5c;
      color: white;
      padding: 15px;
      font-size: 22px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    header img { height: 40px; margin-right: 10px; }
    .container {
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      margin: 30px auto;
      width: 90%;
      max-width: 800px;
      padding: 20px;
    }
    .bid {
      font-size: 40px;
      font-weight: bold;
      color: orange;
      margin: 10px 0;
    }
    input, button {
      padding: 8px 14px;
      font-size: 15px;
      border-radius: 5px;
      border: 1px solid #ccc;
      margin: 5px;
    }
    button {
      cursor: pointer;
      background: #007bff;
      color: white;
      border: none;
    }
    button:hover { background: #0056b3; }
    .ownerGrid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin: 20px auto;
      max-width: 700px;
    }
    .ownerCard {
      background: #003d82;
      color: white;
      border-radius: 8px;
      padding: 10px;
      cursor: pointer;
      transition: 0.2s;
    }
    .ownerCard:hover { background: #0056b3; }
    .ownerCard .wallet { font-size: 13px; color: #b6e1ff; }
    .soldList {
      background: #f9fafc;
      border-radius: 10px;
      padding: 15px;
      margin: 20px auto;
      width: 90%;
      max-width: 800px;
      text-align: left;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }
    .sold { border-bottom: 1px solid #ddd; padding: 6px 0; }
  </style>
</head>
<body>
  <header>
    <img src="assets/logo.png" alt="Olive Logo"> OPL 2025 ‚Äî Admin Control Panel
  </header>

  <div class="container">
    <h3>Select Player to Start Auction</h3>
    <p id="playerName">---</p>
    <p>Type: <span id="playerType">---</span> | Base Price: ‚Çπ<span id="basePrice">0</span></p>
    <div class="bid" id="currentBid">‚Çπ0</div>
    <p>Top Bidder: <span id="currentBidder">---</span></p>

    <input id="searchBox" type="text" placeholder="Search Player..." />
    <button onclick="searchPlayer()">Search Player</button>

    <div class="ownerGrid" id="ownerGrid"></div>

    <div>
      <button onclick="increaseBid(INCREMENTS.oneL)">+1 Lakh</button>
      <button onclick="increaseBid(INCREMENTS.fiveL)">+5 Lakh</button>
      <button onclick="increaseBid(INCREMENTS.tenL)">+10 Lakh</button>
      <button onclick="increaseBid(INCREMENTS.twentyFiveL)">+25 Lakh</button>
      <button onclick="increaseBid(INCREMENTS.fiftyL)">+50 Lakh</button>
      <button onclick="increaseBid(INCREMENTS.oneCr)">+1 Crore</button>
      <button style="background:green" onclick="markSold()">Mark Sold</button>
    </div>
  </div>

  <div class="soldList">
    <h4>üèè Sold Players / Auction History</h4>
    <div id="soldList"></div>
  </div>

  <footer style="background:#002b5c;color:white;padding:10px;font-size:14px;">
    ¬© 2025 Olive Crypto Systems Pvt. Ltd. ‚Äî OPL 2025 Admin Control
  </footer>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    // ‚úÖ Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDw6bKSkntytlnKFGCW5OTwiv44vE5sIxY",
      authDomain: "opl-2025-season-2.firebaseapp.com",
      databaseURL: "https://opl-2025-season-2-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "opl-2025-season-2",
      storageBucket: "opl-2025-season-2.firebasestorage.app",
      messagingSenderId: "282929654033",
      appId: "1:282929654033:web:535ab2b78937cdfa2b04b0"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // üí∞ Conversion
    const L = 100000, Cr = 10000000;
    const crToRs = c => Math.round(c * Cr);

    // üßç Owners
    const initialOwners = {
      "Sharath": { captain: "Kalyan", walletCr: 64.5 },
      "Sarath Chava": { captain: "Sai", walletCr: 77 },
      "Teja": { captain: "Shashank", walletCr: 75 },
      "Vamsi": { captain: "Surender", walletCr: 69.5 },
      "Rajan": { captain: "Vamsi", walletCr: 62 },
      "Shabeer": { captain: "Vijayander", walletCr: 70 },
      "Ravi Raj": { captain: "Suresh", walletCr: 72 },
      "Mahinder": { captain: "Sai Varma", walletCr: 66 }
    };

    // Initialize wallets if missing
    function initOwners() {
      Object.entries(initialOwners).forEach(([name, o]) => {
        db.ref('owners/' + name).once('value').then(s => {
          if (!s.exists()) {
            db.ref('owners/' + name).set({
              captain: o.captain,
              wallet: crToRs(o.walletCr)
            });
          }
        });
      });
    }

    // üßÆ Variables
    let players = {};
    let selectedKey = null;
    let currentBid = 0;
    let currentBidder = null;

    const INCREMENTS = { oneL:L, fiveL:5*L, tenL:10*L, twentyFiveL:25*L, fiftyL:50*L, oneCr:1*Cr };

    // üßæ Player data
    db.ref('players').on('value', s => { players = s.val() || {}; });

    // üßç Owner grid
    function loadOwnersGrid() {
      const grid = document.getElementById('ownerGrid');
      grid.innerHTML = '';
      Object.keys(initialOwners).forEach(name => {
        const d = document.createElement('div');
        d.className = 'ownerCard';
        d.innerHTML = `<div>${name}</div><div>${initialOwners[name].captain}</div><div class="wallet" id="wallet_${name}">Loading...</div>`;
        d.onclick = () => selectBidder(name);
        grid.appendChild(d);
      });
      db.ref('owners').on('value', s => {
        const obj = s.val() || {};
        Object.keys(obj).forEach(k => {
          const el = document.getElementById('wallet_' + k);
          if (el) el.innerText = '‚Çπ' + Number(obj[k].wallet || 0).toLocaleString() + ' (' + ((Number(obj[k].wallet||0)/Cr).toFixed(2)) + 'Cr)';
        });
      });
    }

    // üîç Search player
    function searchPlayer() {
      const q = document.getElementById('searchBox').value.toLowerCase();
      const key = Object.keys(players).find(k => (players[k].name || '').toLowerCase().includes(q));
      if (!key) return alert('Player not found');
      selectedKey = key;
      const p = players[key];
      document.getElementById('playerName').innerText = p.name;
      document.getElementById('playerType').innerText = p.type;
      document.getElementById('basePrice').innerText = p.basePrice || 0;
      currentBid = Number(p.currentBid || 0);
      updateBid();
    }

    // üëÜ Select bidder
    function selectBidder(name) {
      currentBidder = name;
      document.getElementById('currentBidder').innerText = name;
    }

    // üí∏ Increase bid
    async function increaseBid(amount) {
      if (!selectedKey) return alert('Select a player first');
      if (!currentBidder) return alert('Select an owner first');
      const snap = await db.ref('owners/' + currentBidder + '/wallet').once('value');
      const wallet = Number(snap.val() || 0);
      const proposed = currentBid + amount;
      if (wallet < proposed) return alert('Not enough balance');
      currentBid = proposed;
      updateBid();
      db.ref('live').set({ currentPlayerKey:selectedKey, currentBid, currentBidder });
    }

    // ‚úÖ Mark sold
    function markSold() {
      if (!selectedKey || !currentBidder) return alert('Select player and owner');
      const ref = db.ref('owners/' + currentBidder + '/wallet');
      ref.transaction(wallet => wallet - currentBid, async (err, committed) => {
        if (!committed) return alert('Not enough balance');
        const p = players[selectedKey];
        const data = { ...p, team: currentBidder, currentBid, status:'sold' };
        await db.ref('players/' + selectedKey).update(data);
        await db.ref('soldPlayers').push(data);
        alert(`${p.name} sold to ${currentBidder} for ‚Çπ${currentBid.toLocaleString()}`);
        currentBid = 0;
        updateBid();
        document.getElementById('currentBidder').innerText = '---';
      });
    }

    // ü™Ñ Update bid
    function updateBid() {
      document.getElementById('currentBid').innerText = '‚Çπ' + currentBid.toLocaleString();
    }

    // üßæ Sold history
    db.ref('soldPlayers').on('value', s => {
      const el = document.getElementById('soldList');
      el.innerHTML = '';
      if (!s.exists()) return;
      Object.values(s.val()).reverse().forEach(p => {
        const d = document.createElement('div');
        d.className = 'sold';
        d.innerHTML = `<strong>${p.name}</strong> ‚Äî ‚Çπ${p.currentBid.toLocaleString()} | ${p.team}`;
        el.appendChild(d);
      });
    });

    // üöÄ Init
    initOwners();
    loadOwnersGrid();
  </script>
</body>
</html>
